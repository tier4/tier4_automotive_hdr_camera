#!/bin/sh -e

set -e

NAME=tier4-camera-gmsl
PACKAGE_NAME=$NAME
DEB_NAME=$(echo $PACKAGE_NAME | sed 's,_,-,')
CVERSION=`dpkg-query -W -f='${Version}' $DEB_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`
ARCH=`dpkg --print-architecture`

dkms_configure () {
	for POSTINST in /usr/lib/dkms/common.postinst "/usr/share/$PACKAGE_NAME/postinst"; do
		if [ -f "$POSTINST" ]; then
			"$POSTINST" "$NAME" "$CVERSION" "/usr/share/$PACKAGE_NAME" "$ARCH" "$2"
			return $?
		fi
		echo "WARNING: $POSTINST does not exist." >&2
	done
	echo "ERROR: DKMS version is too old and $PACKAGE_NAME was not" >&2
	echo "built with legacy DKMS support." >&2
	echo "You must either rebuild $PACKAGE_NAME with legacy postinst" >&2
	echo "support or upgrade DKMS to a more current version." >&2
	return 1
}

case "$1" in
	configure)
		dkms_configure
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# Preserve the udev rules for the running hardware platform, and delete the others
RQX59G_DT=RQX590
RQX59G_CNT=$(head /proc/device-tree/model | tr -d "\0" | grep -c $RQX59G_DT) || true
if [ $RQX59G_CNT -eq 1 ]; then
	# Preserve udev rules for RQX59G, delete the others
	rm -f /etc/udev/rules.d/99-tier4-isx021-imx490-gmsl.rules
else
	# Preserve udev rules for default Orin, delete the others
	rm -f /etc/udev/rules.d/99-tier4-isx021-imx490-rqx59g.rules
fi

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
